name: Trigger AI Review

on:
  pull_request:
    types: [labeled]

permissions:
  actions: read
  contents: write
  id-token: write
  pull-requests: read

jobs:
  trigger-review:
    name: Trigger Claude Code Review
    if: github.event.label.name == 'ai-review'
    runs-on: ubuntu-latest
    env:
      _BOT_EMAIL: 106330231+bitwarden-devops-bot@users.noreply.github.com
      _BOT_NAME: bitwarden-devops-bot
    steps:
      - name: Log in to Azure
        uses: bitwarden/gh-actions/azure-login@main
        with:
          subscription_id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          tenant_id: ${{ secrets.AZURE_TENANT_ID }}
          client_id: ${{ secrets.AZURE_CLIENT_ID }}

      - name: Get Azure Key Vault secrets
        id: get-kv-secrets
        uses: bitwarden/gh-actions/get-keyvault-secrets@main
        with:
          keyvault: gh-org-bitwarden
          secrets: "BW-GHAPP-ID,BW-GHAPP-KEY"

      - name: Log out from Azure
        uses: bitwarden/gh-actions/azure-logout@main

      - name: Generate GH App token
        uses: actions/create-github-app-token@a8d616148505b5069dccd32f177bb87d7f39123b # v2.1.1
        id: app-token
        with:
          app-id: ${{ steps.get-kv-secrets.outputs.BW-GHAPP-ID }}
          private-key: ${{ steps.get-kv-secrets.outputs.BW-GHAPP-KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}

      - name: Checkout PR branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Configure Git & push empty commit to trigger Claude Code review
        env:
          _PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          git config --local user.email "${_BOT_EMAIL}"
          git config --local user.name "${_BOT_NAME}"
          git commit --allow-empty -m "Claude Code review requested"
          git push origin "${_PR_BRANCH}"
